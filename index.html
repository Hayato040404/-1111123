<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>EWCå°é¢¨é€²è·¯å›³</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    html, body { margin:0; padding:0; height:100%; width:100%; overflow:hidden; background:#000; font-family:"Noto Sans JP",sans-serif; }
    #map { position:absolute; top:0; left:0; width:100%; height:100%; }
    #infobox {
      position:absolute; top:0; right:0; bottom:0; width:300px;
      background:#111; color:#fff; padding:15px; z-index:999; font-size:20px;
      border-left:2px solid #ff6c00; box-sizing:border-box; overflow-y:auto;
    }
    #infobox h2 { font-size:22px; margin:0 0 12px 0; border-bottom:1px solid #444; padding-bottom:8px; }
    #titlebox {
      position:absolute; top:0; left:0; background:rgba(17,17,17,0.9); color:#fff;
      padding:10px 16px; z-index:1000; font-size:20px; font-weight:700;
      border-right:2px solid #ff6c00; border-bottom:2px solid #ff6c00; border-radius:0 0 8px 0;
      display:none;
    }
    .info-item{ margin-bottom:12px; border-left:4px solid #ff6c00; padding-left:8px; }
    .leaflet_datetext { color:white; font-size:12px; font-weight:700; text-shadow:1px 1px 2px #000; }
    #typhoon-selector-container { position:absolute; bottom:18px; left:10px; z-index:1000; width:320px; }
    #typhoon-selector { width:100%; padding:8px; background:#333; color:#fff; border:1px solid #555; border-radius:6px; font-size:15px; }
    /* simple context menu */
    #context-menu { position:absolute; background:rgba(30,30,30,0.95); border:1px solid #ff6c00; border-radius:6px; padding:6px 0; z-index:1001; box-shadow:0 2px 10px rgba(0,0,0,0.5); }
    .context-menu-item{ padding:8px 18px; color:#fff; cursor:pointer; font-size:14px; }
    .context-menu-item:hover{ background:#ff6c00; }
    .context-menu-separator{ border-top:1px solid #555; margin:6px 0; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="titlebox"></div>

  <div id="infobox">
    <h2>ğŸŒ€ EWCå°é¢¨æƒ…å ±</h2>
    <div class="info-item"><span>å®Ÿæ³æ™‚åˆ»:</span><span id="time">-</span></div>
    <div class="info-item"><span>ä¸­å¿ƒæ°—åœ§:</span><span id="pressure">-</span></div>
    <div class="info-item"><span>æœ€å¤§é¢¨é€Ÿ:</span><span id="wind">-</span></div>
    <div class="info-item"><span>æœ€å¤§ç¬é–“é¢¨é€Ÿ:</span><span id="gust">-</span></div>
    <div class="info-item"><span>ç§»å‹•æ–¹å‘:</span><span id="direction">-</span></div>
    <div class="info-item"><span>ç§»å‹•é€Ÿåº¦:</span><span id="speed">-</span></div>
    <div class="info-item"><span>ä¸­å¿ƒä½ç½®:</span><span id="location">-</span></div>
  </div>

  <div id="typhoon-selector-container"></div>

<script>
/* ============================
   åœ°å›³åˆæœŸåŒ–
   ============================ */
const map = L.map('map', {
  center: [36.65, 138.18],
  zoom: 5,
  zoomControl: false,
  scrollWheelZoom: true,
  zoomSnap: 0.1,
  zoomDelta: 0.1
});
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
  attribution: 'Â© OpenStreetMap contributors Â© CartoDB',
  subdomains: 'abcd',
  maxZoom: 19
}).addTo(map);

const allList = L.layerGroup().addTo(map);
const textList = L.layerGroup().addTo(map);

/* ============================
   è£œåŠ©é–¢æ•°
   ============================ */
// URL ã‚¯ã‚¨ãƒª (ä¾‹: ?19) ã‹ã‚‰æ•°å­—ã‚’å–ã‚Šå‡ºã™ã€‚æ•°å­—ã®ã¿ãªã‚‰è¿”ã™ï¼ˆæ•°å€¤å‹ï¼‰ã€ãã†ã§ãªã‘ã‚Œã° null
function getQueryTyphoonNumber() {
  const q = (window.location.search || '').replace('?', '').trim();
  if (/^\d+$/.test(q)) return parseInt(q, 10);
  return null;
}
// typhoonNumber ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆä¾‹: "2519"ï¼‰ã®ã€ŒçŸ­ç¸®ç•ªå·ã€ã‚’è¿”ã™ï¼ˆä¾‹ => 19ï¼‰
function shortTyphoonNumber(typhoonNumber) {
  if (!typhoonNumber && typhoonNumber !== 0) return '';
  const s = String(typhoonNumber);
  // æœ«å°¾2æ¡ã‚’çŸ­ç¸®ç•ªå·ã¨ã—ã¦æ‰±ã†ï¼ˆä¾‹"2519" -> "19"ï¼‰
  return s.length <= 2 ? s : s.slice(-2);
}
// å®‰å…¨ã«ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ã¦ innerHTML ã«å…¥ã‚Œã‚‹å ´åˆã«ä½¿ã†
function escapeHtml(str) {
  if (str === null || str === undefined) return '';
  return String(str).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]);
}

/* ============================
   å°é¢¨æç”»å‡¦ç†ï¼ˆå…ƒã‚³ãƒ¼ãƒ‰ã‚’æµç”¨ï¼‰
   å¼•æ•°: forecast(jsonArray), spec(jsonArray)
   ============================ */
function drawTyphoon(forecast, spec) {
  allList.clearLayers();
  textList.clearLayers();

  const titleBox = document.getElementById("titlebox");

  if (!Array.isArray(forecast) || forecast.length < 2 || !Array.isArray(spec) || spec.length < 1) {
    titleBox.style.display = 'none';
    document.querySelector("#infobox h2").textContent = "å°é¢¨æƒ…å ±ãªã—";
    document.getElementById("time").textContent = "-";
    document.getElementById("pressure").textContent = "-";
    document.getElementById("wind").textContent = "-";
    document.getElementById("gust").textContent = "-";
    document.getElementById("direction").textContent = "-";
    document.getElementById("speed").textContent = "-";
    document.getElementById("location").textContent = "-";
    return;
  }

  const titleInfo = forecast[0] || {};
  // titleInfo.typhoonNumber ã®å½¢å¼ã¯å ´åˆã«ã‚ˆã‚‹ãŸã‚å®‰å…¨ã«æ‰±ã†
  const typhoonNumberRaw = String(titleInfo.typhoonNumber || '');
  // è¡¨ç¤ºç”¨: çŸ­ç¸®ç•ªå·ã¨ãƒ•ãƒ«ç•ªå·ã®ä½µè¨˜ (ä¾‹: å°é¢¨19å· (2519))
  const shortNum = shortTyphoonNumber(typhoonNumberRaw);
  const displayFull = typhoonNumberRaw || '';
  const nameEn = titleInfo.name?.en || '';
  const titleText = nameEn ? `ğŸŒ€ å°é¢¨${shortNum}å· (${displayFull}) â€” ${escapeHtml(nameEn)}` : `ğŸŒ€ å°é¢¨${shortNum}å· (${displayFull})`;

  titleBox.textContent = titleText;
  titleBox.style.display = 'block';
  document.querySelector("#infobox h2").textContent = "è©³ç´°æƒ…å ±";

  // ã€Œå®Ÿæ³ã€ã‚’æ¢ã™
  const currentForecast = forecast.find(f => typeof f.part === 'object' && (f.part.jp === "å®Ÿæ³" || f.part.en === "Analysis" || f.part.ja === "å®Ÿæ³")) || forecast[1] || forecast[0];
  if (!currentForecast || !currentForecast.center) {
    // ä¸­å¿ƒåº§æ¨™ãŒç„¡ã‘ã‚Œã°æç”»ä¸å¯
    return;
  }

  const center = currentForecast.center; // [lat, lng]
  const track = currentForecast.track?.typhoon;
  const preTrack = currentForecast.track?.preTyphoon;

  let forecastBounds = L.latLngBounds([center]);
  let galeBounds = null;

  if (Array.isArray(preTrack)) L.polyline(preTrack, { color: "#00bfff", weight: 2, dashArray: "5,5" }).addTo(allList);
  if (Array.isArray(track)) L.polyline(track, { color: "#00bfff", weight: 4 }).addTo(allList);

  L.circleMarker(center, { radius: 8, fillColor: "#ff0000", color: "#fff", weight: 2, opacity: 1, fillOpacity: 0.9 }).addTo(allList);
  L.marker(center, { icon: L.divIcon({ html: '<div class="leaflet_datetext">ç¾åœ¨</div>', iconSize: [0,0], iconAnchor: [-20,10] }) }).addTo(textList);

  const storm = currentForecast.stormWarningArea?.arc?.[0];
  if (storm && storm[1]) {
    L.circle(center, { radius: storm[1], color: "#ff0000", fillColor: "#ff0000", weight: 0, fillOpacity: 0.2 }).addTo(allList);
  }

  const gale = currentForecast.galeWarningArea;
  if (gale && gale.radius) {
    L.circle(center, { radius: gale.radius, color: "#ffff00", fillColor: "#ffff00", weight: 0, fillOpacity: 0.15 }).addTo(allList);

    galeBounds = L.latLngBounds();
    const latOffset = gale.radius / 111000;
    const lngOffset = gale.radius / (111000 * Math.cos(center[0] * Math.PI / 180));
    galeBounds.extend([center[0] - latOffset, center[1] - lngOffset]);
    galeBounds.extend([center[0] + latOffset, center[1] + lngOffset]);
  }

  for (let i = 2; i < forecast.length; i++) {
    const item = forecast[i];
    if (!item || !item.center || !item.probabilityCircle) continue;

    const forecastCenter = item.center;
    const probCircle = item.probabilityCircle;
    const radius = probCircle.radius;

    L.circle(forecastCenter, { radius: radius, color: "#ffffff", weight: 2, fillOpacity: 0 }).addTo(allList);

    const tangentKey = Object.keys(probCircle || {}).find(k => k.startsWith('tangent'));
    if (tangentKey) {
      const tangentData = probCircle[tangentKey];
      if (Array.isArray(tangentData)) {
        L.polyline(tangentData[0], { color: "#ffffff", weight: 2, dashArray: "6 4" }).addTo(allList);
        L.polyline(tangentData[1], { color: "#ffffff", weight: 2, dashArray: "6 4" }).addTo(allList);
      }
    }

    const latOffset = radius / 111000;
    const lngOffset = radius / (111000 * Math.cos(forecastCenter[0] * Math.PI / 180));
    forecastBounds.extend([forecastCenter[0] - latOffset, forecastCenter[1] - lngOffset]);
    forecastBounds.extend([forecastCenter[0] + latOffset, forecastCenter[1] + lngOffset]);

    const dt = new Date(item.validtime?.JST || item.validtime || item.time || Date.now());
    const label = `${dt.getDate()}æ—¥${dt.getHours()}æ™‚`;
    L.marker(forecastCenter, { icon: L.divIcon({ html: `<div class="leaflet_datetext">${label}</div>`, iconSize:[0,0], iconAnchor:[-20,10] }) }).addTo(textList);
  }

  // è¡¨ç¤ºç¯„å›²ã®æ±ºå®šï¼ˆäºˆå ±å††ã¨æš´é¢¨åŸŸã®åŒæ–¹ã‚’è€ƒæ…®ï¼‰
  let targetBounds = L.latLngBounds(forecastBounds.getSouthWest(), forecastBounds.getNorthEast());
  if (galeBounds) targetBounds.extend(galeBounds);
  map.fitBounds(targetBounds.pad(0.2), { padding: [60, 60] });

  // spec ã‹ã‚‰å®Ÿæ³ç›¸å½“ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ‹¾ã£ã¦ infobox ã«è¡¨ç¤º
  const currentSpec = (Array.isArray(spec) && spec.find(s => s.advancedHours === 0)) || spec[0] || {};
  const info = {
    time: currentForecast?.validtime?.JST?.replace("T"," ")?.slice(0,16) || (currentForecast?.validtime || "-"),
    pressure: currentSpec?.pressure || "-",
    wind: currentSpec?.maximumWind?.sustained?.["m/s"] || "-",
    gust: currentSpec?.maximumWind?.gust?.["m/s"] || "-",
    direction: currentSpec?.course || "-",
    speed: currentSpec?.speed?.["km/h"] || "-",
    location: currentSpec?.location || "-"
  };
  document.getElementById("time").textContent = info.time;
  document.getElementById("pressure").textContent = info.pressure ? `${info.pressure} hPa` : "-";
  document.getElementById("wind").textContent = info.wind ? `${info.wind} m/s` : "-";
  document.getElementById("gust").textContent = info.gust ? `${info.gust} m/s` : "-";
  document.getElementById("direction").textContent = info.direction;
  document.getElementById("speed").textContent = info.speed ? `${info.speed} km/h` : "-";
  document.getElementById("location").textContent = info.location;
}

/* ============================
   å°é¢¨ãƒªã‚¹ãƒˆå–å¾— -> ã‚»ãƒ¬ã‚¯ã‚¿ç”Ÿæˆ -> é¸æŠæ™‚ã« forecast/spec ã‚’å–å¾—ã—ã¦æç”»
   URLã‚¯ã‚¨ãƒª (?19) ãŒã‚ã‚Œã°è‡ªå‹•é¸æŠ
   ============================ */
async function loadTyphoonListAndInit() {
  const selectorContainer = document.getElementById('typhoon-selector-container');
  selectorContainer.innerHTML = ''; // ã‚¯ãƒªã‚¢

  // 1) å°é¢¨ãƒªã‚¹ãƒˆã‚’å–å¾—ï¼ˆãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã¯ä½¿ã‚ãªã„ï¼‰
  let list;
  try {
    const resp = await fetch('https://www.jma.go.jp/bosai/typhoon/data/targetTc.json');
    if (!resp.ok) throw new Error('targetTc.json not ok: ' + resp.status);
    list = await resp.json();
  } catch (e) {
    console.error('æ°—è±¡åº targetTc.json ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', e);
    // ãƒ¢ãƒƒã‚¯ã¯ä½¿ã‚ãªã„ãŸã‚ã€å°é¢¨ãŒå–å¾—ã§ããªã‘ã‚Œã°ä¸€è¦§ã¯ä½œã‚‰ãšçµ‚äº†ã™ã‚‹
    drawTyphoon([], []);
    return;
  }

  if (!Array.isArray(list) || list.length === 0) {
    drawTyphoon([], []);
    return;
  }

  // 2) ã‚»ãƒ¬ã‚¯ã‚¿ã‚’ä½œã‚‹ï¼ˆé…å»¶ãƒ­ãƒ¼ãƒ‰æ–¹å¼ï¼šé¸ã‚“ã ã¨ãã«è©³ç´° fetchï¼‰
  const selector = document.createElement('select');
  selector.id = 'typhoon-selector';

  list.forEach(item => {
    const opt = document.createElement('option');
    opt.value = item.tropicalCyclone; // ä¾‹: "TC2524"
    // è¡¨ç¤ºãƒ©ãƒ™ãƒ«: çŸ­ç¸®ç•ªå· (ãƒ•ãƒ«ç•ªå·) â€” tropicalCyclone â€” ç™ºè¡¨æ™‚åˆ»ï¼ˆè¦‹ã‚„ã™ãï¼‰
    const shortNum = shortTyphoonNumber(item.typhoonNumber);
    const labelTime = item.issue ? (new Date(item.issue)).toLocaleString('ja-JP', { hour12:false }) : '';
    opt.textContent = `å°é¢¨${shortNum}å· (${item.typhoonNumber}) â€” ${item.tropicalCyclone} ${labelTime}`;
    opt.dataset.typhoonNumber = String(item.typhoonNumber || '');
    selector.appendChild(opt);
  });

  selectorContainer.appendChild(selector);

  // 3) URLã‚¯ã‚¨ãƒªã§ã®åˆæœŸé¸æŠ
  const qNum = getQueryTyphoonNumber(); // æ•°å€¤ or null
  let initialIndex = 0;
  if (qNum !== null) {
    // list ä¸­ã§çŸ­ç¸®ç•ªå·ãŒä¸€è‡´ã™ã‚‹ã‚‚ã®ã‚’æ¢ã™ï¼ˆæœ«å°¾ãŒã‚¯ã‚¨ãƒªã®æ•°å­—ã¨ä¸€è‡´ã™ã‚‹ã‹ï¼‰
    const foundIndex = list.findIndex(item => {
      const tn = String(item.typhoonNumber || '');
      return tn.endsWith(String(qNum));
    });
    if (foundIndex !== -1) initialIndex = foundIndex;
    // è¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã°åˆæœŸ 0 ã®ã¾ã¾
  }

  // helper: é¸æŠã•ã‚ŒãŸ tropicalCyclone ã«å¯¾ã—ã¦è©³ç´°ã‚’å–å¾—ã—ã¦æç”»
  async function loadAndDrawTyphoon(tcId, optionEl) {
    if (!tcId) { drawTyphoon([], []); return; }
    try {
      const [forecastResp, specResp] = await Promise.all([
        fetch(`https://www.jma.go.jp/bosai/typhoon/data/${tcId}/forecast.json`),
        fetch(`https://www.jma.go.jp/bosai/typhoon/data/${tcId}/specifications.json`)
      ]);
      if (!forecastResp.ok || !specResp.ok) throw new Error('forecast/spec å–å¾—å¤±æ•—');
      const forecast = await forecastResp.json();
      const spec = await specResp.json();
      drawTyphoon(forecast, spec);

      // å–å¾—æˆåŠŸãªã‚‰ option ã®ãƒ©ãƒ™ãƒ«ã‚’è‹±åä»˜ãã«æ›´æ–°ï¼ˆå­˜åœ¨ã™ã‚Œã°ï¼‰
      try {
        const nameEn = forecast?.[0]?.name?.en;
        const fullNum = String(forecast?.[0]?.typhoonNumber || optionEl?.dataset?.typhoonNumber || '');
        const shortNum = shortTyphoonNumber(fullNum);
        if (optionEl && nameEn) {
          optionEl.textContent = `å°é¢¨${shortNum}å· (${fullNum}) â€” ${nameEn}`;
        }
      } catch(e){ /* å¿µã®ãŸã‚ç„¡è¦– */ }

    } catch (err) {
      console.error('å°é¢¨è©³ç´°ã®å–å¾—ã«å¤±æ•—:', err);
      drawTyphoon([], []);
    }
  }

  // ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
  selector.addEventListener('change', ev => {
    const tcId = ev.target.value;
    const opt = ev.target.selectedOptions[0];
    loadAndDrawTyphoon(tcId, opt);
    // URL ã‚’ç¾åœ¨é¸æŠã«åˆã‚ã›ã¦æ›¸ãæ›ãˆã‚‹ï¼ˆå±¥æ­´ã‚’æ±šã•ãªã„ replaceStateï¼‰
    const short = shortTyphoonNumber(opt.dataset.typhoonNumber || '');
    if (short) history.replaceState(null, '', location.pathname + '?' + encodeURIComponent(short));
  });

  // åˆæœŸé¸æŠã—ã¦ãƒ­ãƒ¼ãƒ‰
  selector.selectedIndex = initialIndex;
  const initOpt = selector.options[initialIndex];
  if (initOpt) {
    // query ãŒã‚ã‚Œã° URL ã‚’çŸ­ç¸®ç•ªå·ã§çµ±ä¸€ï¼ˆæ—¢ã«ãã†ãªã‚‰å¤‰ã‚ã‚‰ãªã„ï¼‰
    const short = shortTyphoonNumber(initOpt.dataset.typhoonNumber || '');
    if (short) history.replaceState(null, '', location.pathname + '?' + encodeURIComponent(short));
    await loadAndDrawTyphoon(initOpt.value, initOpt);
  }
}

/* ============================
   ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ç­‰ï¼ˆãã®ã¾ã¾ï¼‰
   ============================ */
const japanBounds = L.latLngBounds([[21, 122], [50, 159]]);
const asiaBounds = L.latLngBounds([[-11, 70], [55, 230]]);
let previousBounds = null;
function removeContextMenu() { const el = document.getElementById('context-menu'); if (el) el.remove(); }

map.on('contextmenu', function(e) {
  e.originalEvent.preventDefault();
  removeContextMenu();
  const menu = document.createElement('div');
  menu.id = 'context-menu';
  menu.style.left = e.containerPoint.x + 'px';
  menu.style.top = e.containerPoint.y + 'px';

  const showJapan = document.createElement('div');
  showJapan.className = 'context-menu-item';
  showJapan.textContent = 'æ—¥æœ¬å…¨ä½“ã‚’è¡¨ç¤º';
  showJapan.onclick = () => { if (!previousBounds) previousBounds = map.getBounds(); map.fitBounds(japanBounds); removeContextMenu(); };

  const showAsia = document.createElement('div');
  showAsia.className = 'context-menu-item';
  showAsia.textContent = 'ã‚¢ã‚¸ã‚¢å…¨ä½“ã‚’è¡¨ç¤º';
  showAsia.onclick = () => { if (!previousBounds) previousBounds = map.getBounds(); map.fitBounds(asiaBounds); removeContextMenu(); };

  menu.appendChild(showJapan);
  menu.appendChild(showAsia);

  if (previousBounds) {
    const sep = document.createElement('div'); sep.className = 'context-menu-separator'; menu.appendChild(sep);
    const revert = document.createElement('div'); revert.className = 'context-menu-item'; revert.textContent = 'å…ƒã®é ˜åŸŸã«æˆ»ã™';
    revert.onclick = () => { map.fitBounds(previousBounds); removeContextMenu(); };
    menu.appendChild(revert);
  }

  map.getContainer().appendChild(menu);
});
map.on('click', removeContextMenu);

/* ============================
   åˆæœŸåŒ–
   ============================ */
loadTyphoonListAndInit();

</script>
</body>
</html>
