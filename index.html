import React, { useState, useRef, useEffect } from 'react';
import { Camera, Mic, Square, Volume2, VolumeX, Film, Download, BarChart3 } from 'lucide-react';

export default function BaseballCommentary() {
  const [isStreaming, setIsStreaming] = useState(false);
  const [isCommenting, setIsCommenting] = useState(false);
  const [isSpeechEnabled, setIsSpeechEnabled] = useState(true);
  const [commentary, setCommentary] = useState('');
  const [allComments, setAllComments] = useState([]);
  const [motionLevel, setMotionLevel] = useState(0);
  const [gameStats, setGameStats] = useState({
    pitches: 0,
    hits: 0,
    catches: 0,
    runs: 0,
    totalMotion: 0,
    peakMotion: 0,
    duration: 0
  });
  const [highlights, setHighlights] = useState([]);
  const [showDigest, setShowDigest] = useState(false);
  
  const videoRef = useRef(null);
  const canvasRef = useRef(null);
  const streamRef = useRef(null);
  const previousFrameRef = useRef(null);
  const animationRef = useRef(null);
  const motionHistoryRef = useRef([]);
  const lastEventTimeRef = useRef(0);
  const startTimeRef = useRef(0);
  const durationIntervalRef = useRef(null);

  // å‹•ãæ¤œå‡ºã®è©³ç´°åˆ†æ
  const analyzeMotion = () => {
    const video = videoRef.current;
    const canvas = canvasRef.current;
    if (!video || !canvas || video.readyState !== video.HAVE_ENOUGH_DATA) {
      return { overall: 0, center: 0, left: 0, right: 0, top: 0, bottom: 0 };
    }

    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    canvas.width = 160;
    canvas.height = 120;
    
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const currentFrame = ctx.getImageData(0, 0, canvas.width, canvas.height);
    
    if (!previousFrameRef.current) {
      previousFrameRef.current = currentFrame;
      return { overall: 0, center: 0, left: 0, right: 0, top: 0, bottom: 0 };
    }

    const data = currentFrame.data;
    const prevData = previousFrameRef.current.data;
    const w = canvas.width;
    const h = canvas.height;
    
    // ã‚¨ãƒªã‚¢åˆ¥ã®å‹•ãæ¤œå‡º
    const areas = {
      center: { x: Math.floor(w * 0.35), y: Math.floor(h * 0.3), w: Math.floor(w * 0.3), h: Math.floor(h * 0.4), sum: 0 },
      left: { x: 0, y: Math.floor(h * 0.2), w: Math.floor(w * 0.3), h: Math.floor(h * 0.6), sum: 0 },
      right: { x: Math.floor(w * 0.7), y: Math.floor(h * 0.2), w: Math.floor(w * 0.3), h: Math.floor(h * 0.6), sum: 0 },
      top: { x: Math.floor(w * 0.2), y: 0, w: Math.floor(w * 0.6), h: Math.floor(h * 0.3), sum: 0 },
      bottom: { x: Math.floor(w * 0.2), y: Math.floor(h * 0.7), w: Math.floor(w * 0.6), h: Math.floor(h * 0.3), sum: 0 }
    };

    let overallSum = 0;
    
    Object.keys(areas).forEach(key => {
      const area = areas[key];
      for (let y = area.y; y < area.y + area.h && y < h; y++) {
        for (let x = area.x; x < area.x + area.w && x < w; x++) {
          const i = (y * w + x) * 4;
          const diff = Math.abs(data[i] - prevData[i]) + 
                       Math.abs(data[i + 1] - prevData[i + 1]) + 
                       Math.abs(data[i + 2] - prevData[i + 2]);
          area.sum += diff;
          overallSum += diff;
        }
      }
      area.avg = area.sum / (area.w * area.h * 3);
    });

    previousFrameRef.current = currentFrame;
    
    return {
      overall: overallSum / (w * h * 3),
      center: areas.center.avg,
      left: areas.left.avg,
      right: areas.right.avg,
      top: areas.top.avg,
      bottom: areas.bottom.avg
    };
  };

  // å‹•ããƒ‘ã‚¿ãƒ¼ãƒ³ã®åˆ†æ
  const analyzeMotionPattern = (motion) => {
    motionHistoryRef.current.push(motion);
    if (motionHistoryRef.current.length > 15) {
      motionHistoryRef.current.shift();
    }

    if (motionHistoryRef.current.length < 5) return null;

    const recent = motionHistoryRef.current.slice(-5);
    const avg = recent.reduce((a, b) => a + b.overall, 0) / recent.length;
    const variance = recent.reduce((a, b) => a + Math.pow(b.overall - avg, 2), 0) / recent.length;
    const isSpike = motion.overall > avg + Math.sqrt(variance) * 2;
    
    // å‹•ãã®ç‰¹å¾´ã‚’åˆ†æ
    const pattern = {
      isSpike,
      isSustained: motion.overall > 10 && avg > 8,
      isQuick: isSpike && motion.overall > 20,
      centerDominant: motion.center > motion.left && motion.center > motion.right,
      horizontalMotion: (motion.left > motion.center * 0.7) || (motion.right > motion.center * 0.7),
      verticalMotion: (motion.top > 5) || (motion.bottom > 5),
      leftBias: motion.left > motion.right * 1.3,
      rightBias: motion.right > motion.left * 1.3
    };

    return pattern;
  };

  // ã‚¤ãƒ™ãƒ³ãƒˆåˆ¤å®šã¨å®Ÿæ³ç”Ÿæˆ
  const generateIntelligentCommentary = (motion, pattern) => {
    const now = Date.now();
    const timeSinceLastEvent = now - lastEventTimeRef.current;
    
    // æœ€ä½2ç§’ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«
    if (timeSinceLastEvent < 2000) return;

    let event = null;
    let comment = '';
    let eventType = '';

    // ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°ã«ã‚ˆã‚‹ã‚¤ãƒ™ãƒ³ãƒˆåˆ¤å®š
    if (pattern.isQuick && motion.center > 18) {
      // æŠ•çƒãƒ»ãƒãƒƒãƒˆã‚¹ã‚¤ãƒ³ã‚°
      if (Math.random() > 0.5) {
        eventType = 'pitch';
        const pitchTypes = [
          'ãƒ”ãƒƒãƒãƒ£ãƒ¼ã€åŠ›å¼·ãæŠ•ã’è¾¼ã‚“ã ! ã‚¹ãƒˆãƒ©ã‚¤ã‚¯!',
          'ãƒ”ãƒƒãƒãƒ£ãƒ¼ã€ã‚­ãƒ¬ã®ã‚ã‚‹çƒ! ã„ã„ã‚³ãƒ¼ã‚¹ã«æ±ºã¾ã‚Šã¾ã—ãŸ!',
          'æŠ•ã’ã¾ã—ãŸ! ä½ã‚ã«ã‚ºãƒãƒƒã¨!',
          'ãƒ”ãƒƒãƒãƒ£ãƒ¼ã€ã‚¿ãƒ¡ã‚’ä½œã£ã¦... æŠ•ã’ãŸ!',
        ];
        comment = pitchTypes[Math.floor(Math.random() * pitchTypes.length)];
        setGameStats(prev => ({ ...prev, pitches: prev.pitches + 1 }));
      } else {
        eventType = 'swing';
        const swingTypes = [
          'ãƒãƒƒã‚¿ãƒ¼ã€æ€ã„åˆ‡ã‚ŠæŒ¯ã£ãŸ! å¤§ããªã‚¹ã‚¤ãƒ³ã‚°!',
          'ãƒ•ãƒ«ã‚¹ã‚¤ãƒ³ã‚°! åŠ›å¼·ã„ãƒãƒƒãƒ†ã‚£ãƒ³ã‚°!',
          'æŒ¯ã‚Šã¾ã—ãŸ! ãƒãƒƒãƒˆãŒå”¸ã‚Šã‚’ä¸Šã’ã¦ã„ã¾ã™!',
          'ãƒãƒƒã‚¿ãƒ¼ã€ä¼šå¿ƒã®ä¸€æ’ƒã‚’ç‹™ã„ã¾ã™!',
        ];
        comment = swingTypes[Math.floor(Math.random() * swingTypes.length)];
      }
      event = { type: eventType, intensity: 'high', motion: motion.overall };
      
    } else if (pattern.isSpike && motion.overall > 12) {
      // ãƒ’ãƒƒãƒˆãƒ»ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‡ã‚£ãƒ³ã‚°
      if (pattern.horizontalMotion) {
        eventType = 'hit';
        const hitDirections = pattern.leftBias ? 
          ['æ‰“ã£ãŸ! ãƒ¬ãƒ•ãƒˆæ–¹å‘ã¸!', 'å·¦ç¿¼ç·šã‚’æŠœã‘ã¦ã„ãã¾ã™!', 'ãƒ¬ãƒ•ãƒˆã‚ªãƒ¼ãƒãƒ¼! å¤§ããªå½“ãŸã‚Š!'] :
          ['ãƒ©ã‚¤ãƒˆæ–¹å‘ã¸é£›ã‚“ã§ã„ã!', 'å³ä¸­é–“ã‚’ç ´ã‚‹å½“ãŸã‚Š!', 'ãƒ©ã‚¤ãƒˆãƒ•ãƒ©ã‚¤ã€è¿½ã„ã‹ã‘ã¾ã™!'];
        comment = hitDirections[Math.floor(Math.random() * hitDirections.length)];
        setGameStats(prev => ({ ...prev, hits: prev.hits + 1 }));
        event = { type: eventType, intensity: 'high', motion: motion.overall };
      } else {
        eventType = 'catch';
        const catchTypes = [
          'ãƒŠã‚¤ã‚¹ã‚­ãƒ£ãƒƒãƒ! å®ˆå‚™é™£ã€ãƒ•ã‚¡ã‚¤ãƒ³ãƒ—ãƒ¬ãƒ¼!',
          'ã—ã£ã‹ã‚Šæ•ã£ãŸ! å®ˆå‚™ã®é€£æºã€å®Œç’§ã§ã™!',
          'æ•çƒ! ã‚¢ã‚¦ãƒˆã«ã—ã¾ã—ãŸ!',
          'å®ˆå‚™é™£ã€ç´ æ—©ã„åå¿œ!',
        ];
        comment = catchTypes[Math.floor(Math.random() * catchTypes.length)];
        setGameStats(prev => ({ ...prev, catches: prev.catches + 1 }));
        event = { type: eventType, intensity: 'medium', motion: motion.overall };
      }
      
    } else if (pattern.isSustained && motion.overall > 8) {
      // èµ°å¡
      if (timeSinceLastEvent > 4000) {
        eventType = 'run';
        const runTypes = [
          'ãƒ©ãƒ³ãƒŠãƒ¼ã€ã‚¹ãƒ”ãƒ¼ãƒ‰ã«ä¹—ã£ã¦ã„ã¾ã™!',
          'èµ°ã£ãŸ! ãƒ™ãƒ¼ã‚¹ã‚’ç‹™ã„ã¾ã™!',
          'ä¿Šè¶³ã€è¦‹ã›ã¾ã™! ã„ã„ã‚¹ã‚¿ãƒ¼ãƒˆã§ã™!',
          'ãƒ©ãƒ³ãƒŠãƒ¼ã€æ¬¡ã®å¡ã‚’ç‹™ã£ã¦ã„ã¾ã™!',
        ];
        comment = runTypes[Math.floor(Math.random() * runTypes.length)];
        if (Math.random() > 0.7) {
          setGameStats(prev => ({ ...prev, runs: prev.runs + 1 }));
        }
        event = { type: eventType, intensity: 'medium', motion: motion.overall };
      }
      
    } else if (motion.overall > 4 && timeSinceLastEvent > 5000) {
      // æº–å‚™å‹•ä½œ
      eventType = 'preparation';
      const prepTypes = [
        'ãƒ”ãƒƒãƒãƒ£ãƒ¼ã€ã‚µã‚¤ãƒ³ã‚’ç¢ºèªã—ã¦ã„ã¾ã™',
        'ãƒãƒƒã‚¿ãƒ¼ã€æ§‹ãˆã¾ã—ãŸ',
        'å®ˆå‚™é™£ã€é›†ä¸­ã—ã¦ã„ã¾ã™',
        'ã•ã‚ã€æ¬¡ã®ãƒ—ãƒ¬ãƒ¼ã§ã™',
        'ãƒ©ãƒ³ãƒŠãƒ¼ã€ãƒªãƒ¼ãƒ‰ã‚’å–ã£ã¦ã„ã¾ã™',
      ];
      comment = prepTypes[Math.floor(Math.random() * prepTypes.length)];
      event = { type: eventType, intensity: 'low', motion: motion.overall };
    }

    if (comment && event) {
      lastEventTimeRef.current = now;
      
      setCommentary(comment);
      setAllComments(prev => [{
        time: new Date().toLocaleTimeString('ja-JP'),
        timestamp: now,
        text: comment,
        motion: Math.round(motion.overall),
        type: eventType
      }, ...prev.slice(0, 19)]);

      // ãƒã‚¤ãƒ©ã‚¤ãƒˆåˆ¤å®šï¼ˆé«˜å¼·åº¦ã®ã‚¤ãƒ™ãƒ³ãƒˆï¼‰
      if (event.intensity === 'high' && motion.overall > 15) {
        setHighlights(prev => [...prev, {
          time: new Date().toLocaleTimeString('ja-JP'),
          timestamp: now,
          text: comment,
          type: eventType,
          motion: Math.round(motion.overall)
        }]);
      }

      // éŸ³å£°èª­ã¿ä¸Šã’
      if (isSpeechEnabled && 'speechSynthesis' in window) {
        speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(comment);
        utterance.lang = 'ja-JP';
        utterance.rate = 1.15;
        utterance.pitch = eventType === 'hit' ? 1.2 : 1.0;
        speechSynthesis.speak(utterance);
      }

      // çµ±è¨ˆæ›´æ–°
      setGameStats(prev => ({
        ...prev,
        totalMotion: prev.totalMotion + motion.overall,
        peakMotion: Math.max(prev.peakMotion, motion.overall)
      }));
    }
  };

  // å‹•ãæ¤œå‡ºãƒ«ãƒ¼ãƒ—
  const motionDetectionLoop = () => {
    if (!isCommenting) return;
    
    const motion = analyzeMotion();
    const pattern = analyzeMotionPattern(motion);
    
    setMotionLevel(motion.overall);
    
    if (pattern) {
      generateIntelligentCommentary(motion, pattern);
    }
    
    animationRef.current = requestAnimationFrame(motionDetectionLoop);
  };

  // ã‚«ãƒ¡ãƒ©ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’é–‹å§‹
  const startCamera = async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ 
        video: { facingMode: 'environment', width: 1280, height: 720 },
        audio: false 
      });
      if (videoRef.current) {
        videoRef.current.srcObject = stream;
      }
      streamRef.current = stream;
      setIsStreaming(true);
    } catch (err) {
      alert('ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ: ' + err.message);
    }
  };

  // ã‚«ãƒ¡ãƒ©ã‚’åœæ­¢
  const stopCamera = () => {
    if (streamRef.current) {
      streamRef.current.getTracks().forEach(track => track.stop());
      streamRef.current = null;
    }
    if (animationRef.current) {
      cancelAnimationFrame(animationRef.current);
    }
    if (durationIntervalRef.current) {
      clearInterval(durationIntervalRef.current);
    }
    setIsStreaming(false);
    setIsCommenting(false);
  };

  // å®Ÿæ³é–‹å§‹
  const startCommentary = () => {
    if (!isStreaming) {
      alert('å…ˆã«ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã—ã¦ãã ã•ã„');
      return;
    }
    setIsCommenting(true);
    setCommentary('å®Ÿæ³ã‚’é–‹å§‹ã—ã¾ã™! ãƒ—ãƒ¬ãƒ¼ãƒœãƒ¼ãƒ«!');
    setShowDigest(false);
    
    // çµ±è¨ˆãƒªã‚»ãƒƒãƒˆ
    startTimeRef.current = Date.now();
    setGameStats({
      pitches: 0,
      hits: 0,
      catches: 0,
      runs: 0,
      totalMotion: 0,
      peakMotion: 0,
      duration: 0
    });
    setHighlights([]);
    
    // çµŒéæ™‚é–“ã‚«ã‚¦ãƒ³ãƒˆ
    durationIntervalRef.current = setInterval(() => {
      setGameStats(prev => ({
        ...prev,
        duration: Math.floor((Date.now() - startTimeRef.current) / 1000)
      }));
    }, 1000);
    
    if (isSpeechEnabled && 'speechSynthesis' in window) {
      const utterance = new SpeechSynthesisUtterance('å®Ÿæ³ã‚’é–‹å§‹ã—ã¾ã™! ãƒ—ãƒ¬ãƒ¼ãƒœãƒ¼ãƒ«!');
      utterance.lang = 'ja-JP';
      speechSynthesis.speak(utterance);
    }
    
    previousFrameRef.current = null;
    motionHistoryRef.current = [];
    lastEventTimeRef.current = 0;
    animationRef.current = requestAnimationFrame(motionDetectionLoop);
  };

  // å®Ÿæ³åœæ­¢ã¨ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆç”Ÿæˆ
  const stopCommentary = () => {
    setIsCommenting(false);
    if (animationRef.current) {
      cancelAnimationFrame(animationRef.current);
    }
    if (durationIntervalRef.current) {
      clearInterval(durationIntervalRef.current);
    }
    if ('speechSynthesis' in window) {
      speechSynthesis.cancel();
    }
    
    // ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆè¡¨ç¤º
    if (highlights.length > 0) {
      setShowDigest(true);
      setCommentary('è©¦åˆçµ‚äº†! ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆã‚’ç¢ºèªã§ãã¾ã™');
    }
  };

  // éŸ³å£°ã‚ªãƒ³ã‚ªãƒ•åˆ‡ã‚Šæ›¿ãˆ
  const toggleSpeech = () => {
    setIsSpeechEnabled(!isSpeechEnabled);
    if (!isSpeechEnabled && 'speechSynthesis' in window) {
      const utterance = new SpeechSynthesisUtterance('éŸ³å£°ã‚’ã‚ªãƒ³ã«ã—ã¾ã—ãŸ');
      utterance.lang = 'ja-JP';
      speechSynthesis.speak(utterance);
    } else if ('speechSynthesis' in window) {
      speechSynthesis.cancel();
    }
  };

  // ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆã‚’ãƒ†ã‚­ã‚¹ãƒˆã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
  const downloadDigest = () => {
    const duration = gameStats.duration;
    const minutes = Math.floor(duration / 60);
    const seconds = duration % 60;
    
    let digest = '=== è‰é‡çƒå®Ÿæ³ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆ ===\n\n';
    digest += `è©¦åˆæ™‚é–“: ${minutes}åˆ†${seconds}ç§’\n`;
    digest += `æŠ•çƒæ•°: ${gameStats.pitches}çƒ\n`;
    digest += `ãƒ’ãƒƒãƒˆæ•°: ${gameStats.hits}æœ¬\n`;
    digest += `å®ˆå‚™ãƒ—ãƒ¬ãƒ¼: ${gameStats.catches}å›\n`;
    digest += `èµ°å¡: ${gameStats.runs}å›\n`;
    digest += `å¹³å‡å‹•ã: ${(gameStats.totalMotion / allComments.length).toFixed(1)}\n`;
    digest += `æœ€å¤§å‹•ã: ${gameStats.peakMotion.toFixed(1)}\n\n`;
    digest += '=== ãƒã‚¤ãƒ©ã‚¤ãƒˆ ===\n\n';
    
    highlights.forEach((h, i) => {
      digest += `${i + 1}. [${h.time}] ${h.text} (å‹•ã: ${h.motion})\n`;
    });
    
    digest += '\n=== å…¨å®Ÿæ³ ===\n\n';
    allComments.slice().reverse().forEach((c, i) => {
      digest += `${i + 1}. [${c.time}] ${c.text}\n`;
    });
    
    const blob = new Blob([digest], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `é‡çƒå®Ÿæ³_${new Date().toLocaleDateString('ja-JP')}.txt`;
    a.click();
    URL.revokeObjectURL(url);
  };

  // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
  useEffect(() => {
    return () => {
      stopCamera();
      if (animationRef.current) {
        cancelAnimationFrame(animationRef.current);
      }
      if (durationIntervalRef.current) {
        clearInterval(durationIntervalRef.current);
      }
    };
  }, []);

  const formatTime = (seconds) => {
    const m = Math.floor(seconds / 60);
    const s = seconds % 60;
    return `${m}:${s.toString().padStart(2, '0')}`;
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-green-900 via-green-700 to-green-900 p-4">
      <div className="max-w-6xl mx-auto">
        {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
        <div className="bg-white/10 backdrop-blur-md rounded-2xl p-6 mb-4 border border-white/20">
          <h1 className="text-3xl font-bold text-white mb-2 flex items-center gap-3">
            <Camera className="w-8 h-8" />
            è‰é‡çƒãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å®Ÿæ³ PRO
          </h1>
          <p className="text-white/80 text-sm">
            é«˜åº¦ãªå‹•ãæ¤œå‡ºã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã§å®Ÿæ³ç”Ÿæˆ + ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆè‡ªå‹•ä½œæˆ
          </p>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
          {/* å·¦ã‚«ãƒ©ãƒ : ã‚«ãƒ¡ãƒ©ã¨çµ±è¨ˆ */}
          <div className="lg:col-span-2 space-y-4">
            {/* ã‚«ãƒ¡ãƒ©ãƒ“ãƒ¥ãƒ¼ */}
            <div className="bg-black rounded-2xl overflow-hidden shadow-2xl relative">
              <video
                ref={videoRef}
                autoPlay
                playsInline
                muted
                className="w-full aspect-video object-cover"
              />
              {isCommenting && (
                <>
                  <div className="absolute top-4 right-4 bg-red-600 text-white px-3 py-2 rounded-full text-sm font-bold flex items-center gap-2 shadow-lg">
                    <div className="w-2 h-2 bg-white rounded-full animate-pulse"></div>
                    å®Ÿæ³ä¸­ {formatTime(gameStats.duration)}
                  </div>
                  <div className="absolute bottom-4 left-4 right-4 bg-gradient-to-r from-black/80 to-black/60 backdrop-blur-sm text-white p-3 rounded-lg">
                    <div className="text-xs mb-2 flex justify-between items-center">
                      <span>å‹•ãæ¤œå‡ºãƒ¬ãƒ™ãƒ«</span>
                      <span className="font-mono font-bold">{Math.round(motionLevel)}</span>
                    </div>
                    <div className="h-3 bg-gray-800 rounded-full overflow-hidden">
                      <div 
                        className="h-full bg-gradient-to-r from-green-500 via-yellow-400 to-red-500 transition-all duration-200"
                        style={{ width: `${Math.min(motionLevel * 2.5, 100)}%` }}
                      ></div>
                    </div>
                  </div>
                </>
              )}
            </div>
            
            <canvas ref={canvasRef} style={{ display: 'none' }} />

            {/* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */}
            <div className="bg-white/10 backdrop-blur-md rounded-2xl p-4 border border-white/20">
              <div className="flex gap-3 flex-wrap">
                {!isStreaming ? (
                  <button
                    onClick={startCamera}
                    className="flex-1 min-w-[110px] bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-xl transition flex items-center justify-center gap-2"
                  >
                    <Camera className="w-5 h-5" />
                    ã‚«ãƒ¡ãƒ©èµ·å‹•
                  </button>
                ) : (
                  <button
                    onClick={stopCamera}
                    className="flex-1 min-w-[110px] bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-4 rounded-xl transition flex items-center justify-center gap-2"
                  >
                    <Square className="w-5 h-5" />
                    åœæ­¢
                  </button>
                )}

                {!isCommenting ? (
                  <button
                    onClick={startCommentary}
                    disabled={!isStreaming}
                    className="flex-1 min-w-[110px] bg-green-600 hover:bg-green-700 disabled:bg-gray-600 disabled:opacity-50 text-white font-semibold py-3 px-4 rounded-xl transition flex items-center justify-center gap-2"
                  >
                    <Mic className="w-5 h-5" />
                    å®Ÿæ³é–‹å§‹
                  </button>
                ) : (
                  <button
                    onClick={stopCommentary}
                    className="flex-1 min-w-[110px] bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3 px-4 rounded-xl transition flex items-center justify-center gap-2"
                  >
                    <Film className="w-5 h-5" />
                    çµ‚äº†/ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆ
                  </button>
                )}

                <button
                  onClick={toggleSpeech}
                  className={`min-w-[110px] ${isSpeechEnabled ? 'bg-purple-600 hover:bg-purple-700' : 'bg-gray-600 hover:bg-gray-700'} text-white font-semibold py-3 px-4 rounded-xl transition flex items-center justify-center gap-2`}
                >
                  {isSpeechEnabled ? <Volume2 className="w-5 h-5" /> : <VolumeX className="w-5 h-5" />}
                  éŸ³å£°{isSpeechEnabled ? 'ON' : 'OFF'}
                </button>
              </div>
            </div>

            {/* çµ±è¨ˆãƒ‘ãƒãƒ« */}
            {(isCommenting || allComments.length > 0) && (
              <div className="bg-white/10 backdrop-blur-md rounded-2xl p-4 border border-white/20">
                <div className="flex items-center gap-2 mb-3">
                  <BarChart3 className="w-5 h-5 text-white" />
                  <h3 className="text-lg font-bold text-white">è©¦åˆçµ±è¨ˆ</h3>
                </div>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                  <div className="bg-white/5 rounded-lg p-3 border border-white/10">
                    <div className="text-xs text-white/60 mb-1">æŠ•çƒæ•°</div>
                    <div className="text-2xl font-bold text-white">{gameStats.pitches}</div>
                  </div>
                  <div className="bg-white/5 rounded-lg p-3 border border-white/10">
                    <div className="text-xs text-white/60 mb-1">ãƒ’ãƒƒãƒˆ</div>
                    <div className="text-2xl font-bold text-green-400">{gameStats.hits}</div>
                  </div>
                  <div className="bg-white/5 rounded-lg p-3 border border-white/10">
                    <div className="text-xs text-white/60 mb-1">å®ˆå‚™</div>
                    <div className="text-2xl font-bold text-blue-400">{gameStats.catches}</div>
                  </div>
                  <div className="bg-white/5 rounded-lg p-3 border border-white/10">
                    <div className="text-xs text-white/60 mb-1">èµ°å¡</div>
                    <div className="text-2xl font-bold text-yellow-400">{gameStats.runs}</div>
                  </div>
                </div>
              </div>
            )}
          </div>

          {/* å³ã‚«ãƒ©ãƒ : å®Ÿæ³ã¨ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆ */}
          <div className="space-y-4">
            {/* ç¾åœ¨ã®å®Ÿæ³ */}
            {commentary && !showDigest && (
              <div className="bg-gradient-to-br from-white/15 to-white/5 backdrop-blur-md rounded-2xl p-6 border border-white/30 shadow-xl">
                <div className="flex items-start gap-3">
                  <Mic className="w-6 h-6 text-green-400 flex-shrink-0 mt-1 animate-pulse" />
                  <div className="flex-1">
                    <h3 className="text-sm font-semibold text-white/70 mb-2">å®Ÿæ³ä¸­</h3>
                    <p className="text-lg text-white font-medium leading-relaxed">
                      {commentary}
                    </p>
                  </div>
                </div>
              </div>
            )}

            {/* ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆ */}
            {showDigest && highlights.length > 0 && (
              <div className="bg-gradient-to-br from-yellow-500/20 to-orange-500/20 backdrop-blur-md rounded-2xl p-6 border border-yellow-400/30 shadow-xl">
                <div className="flex items-center justify-between mb-4">
                  <div className="flex items-center gap-2">
                    <Film className="w-6 h-6 text-yellow-400" />
                    <h3 className="text-xl font-bold text-white">ãƒã‚¤ãƒ©ã‚¤ãƒˆ</h3>
                  </div>
                  <button
                    onClick={downloadDigest}
                    className="bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-2 rounded-lg text-sm font-semibold flex items-center gap-2 transition"
                  >
                    <Download className="w-4 h-4" />
                    ä¿å­˜
                  </button>
                </div>
                <div className="space-y-3 max-h-[500px] overflow-y-auto">
                  {highlights.map((h, idx) => (
                    <div key={idx} className="bg-white/10 rounded-lg p-3 border border-white/20">
                      <div className="flex justify-between items-start mb-2">
                        <span className="text-xs text-yellow-300 font-semibold">#{idx + 1}</span>
                        <span className="text-xs text-white/60">{h.time}</span>
                      </div>
                      <p className="text-white font-medium mb-1">{h.text}</p>
                      <div className="flex justify-between items-center text-xs">
                        <span className="text-white/50">{h.type}</span>
                        <span className="text-yellow-400 font-mono">å‹•ã: {h.motion}</span>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* å®Ÿæ³å±¥æ­´ */}
            {allComments.length > 0 && !showDigest && (
              <div className="bg-white/10 backdrop-blur-md rounded-2xl p-6 border border-white/20">
                <h3 className="text-lg font-bold text-white mb-4">å®Ÿæ³å±¥æ­´</h3>
                <div className="space-y-3 max-h-[400px] overflow-y-auto">
                  {allComments.map((comment, idx) => (
                    <div key={idx} className="bg-white/5 rounded-lg p-3 border border-white/10 hover:bg-white/10 transition">
                      <div className="flex justify-between items-center mb-1">
                        <div className="text-xs text-white/50">{comment.time}</div>
                        <div className="flex items-center gap-2">
                          <span className={`text-xs px-2 py-0.5 rounded ${
                            comment.type === 'hit' ? 'bg-green-500/30 text-green-300' :
                            comment.type === 'pitch' ? 'bg-blue-500/30 text-blue-300' :
                            comment.type === 'catch' ? 'bg-purple-500/30 text-purple-300' :
                            comment.type === 'run' ? 'bg-yellow-500/30 text-yellow-300' :
                            'bg-gray-500/30 text-gray-300'
                          }`}>
                            {comment.type}
                          </span>
                          <span className="text-xs text-green-400 font-mono">{comment.motion}</span>
                        </div>
                      </div>
                      <div className="text-white/90">{comment.text}</div>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
        </div>

        {/* èª¬æ˜ */}
        <div className="mt-4 bg-white/5 backdrop-blur-md rounded-xl p-4 border border-white/10">
          <p className="text-white/70 text-sm leading-relaxed">
            <strong className="text-white">ğŸ”¬ é«˜åº¦ãªã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ :</strong><br />
            â€¢ ã‚¨ãƒªã‚¢åˆ¥å‹•ãæ¤œå‡ºï¼ˆä¸­å¤®ãƒ»å·¦å³ãƒ»ä¸Šä¸‹ï¼‰<br />
            â€¢ å‹•ããƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æï¼ˆã‚¹ãƒ‘ã‚¤ã‚¯ãƒ»æŒç¶šãƒ»æ–¹å‘æ€§ï¼‰<br />
            â€¢ ã‚¤ãƒ™ãƒ³ãƒˆåˆ¤å®šï¼ˆæŠ•çƒãƒ»æ‰“æ’ƒãƒ»å®ˆå‚™ãƒ»èµ°å¡ï¼‰<br />
            â€¢ è‡ªå‹•ãƒã‚¤ãƒ©ã‚¤ãƒˆæŠ½å‡º<br />
            <br />
            <strong className="text-yellow-300">ğŸ“Š æ©Ÿèƒ½:</strong><br />
            ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å®Ÿæ³ | è©¦åˆçµ±è¨ˆ | ãƒã‚¤ãƒ©ã‚¤ãƒˆè‡ªå‹•ç”Ÿæˆ | ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          </p>
        </div>
      </div>
    </div>
  );
}
